<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan – Tärningsspel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    table input {
      width: 6ch;
      padding: 0.25rem;
      box-sizing: border-box;
      text-align: center;
    }
    .readonly { background: #eee; }
    .dice-container { margin-bottom: 1rem; }
    .die {
      display: inline-block; width: 40px; height: 40px;
      line-height: 40px; text-align: center;
      font-size: 24px; border: 2px solid #333;
      border-radius: 6px; margin-right: 6px; cursor: pointer;
    }
    .selected { background-color: #d1e7dd; border-color: #0f5132; }
    .player-section { margin-bottom: 2rem; padding: 1rem; border: 2px solid transparent; }
    .active-player { border-color: #0d6efd; background-color: #f0f8ff; }
    .highlighted { background-color: #d4edda !important; }
    .log { font-size: 0.9em; margin-top: 0.5rem; }
    .column-label { width: 60px; text-align: center; }
    .row-label { width: 8ch; text-align: center; }
    .combination { margin-top: 1rem; }
    .combination button { margin: 0.2rem; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Yan – Tärningsspel</h1>
  <div class="mb-3">
    <label for="numPlayers" class="form-label">Antal spelare:</label>
    <input type="number" id="numPlayers" class="form-control" min="1" max="6" value="2">
    <button class="btn btn-primary mt-2" id="startBtn">Starta spel</button>
  </div>
  <h3 id="activePlayerLabel" class="text-primary"></h3>
  <div id="gameArea"></div>
</div>

<script>
let diceValues = [];
let currentPlayer = 0;
let rollCounts = [];
let selectedDice = [];
let gameStarted = false;

const labels = ['1:or','2:or','3:or','4:or','5:or','6:or','SUM','BONUS','MIN','MAX','2 PAR','FULL','STEGE','FYRTAL','YAN'];

document.getElementById("startBtn").addEventListener("click", setupGame);

function setupGame() {
  const numPlayers = parseInt(document.getElementById("numPlayers").value);
  const gameArea = document.getElementById("gameArea");
  gameArea.innerHTML = '';
  rollCounts = new Array(numPlayers).fill(0);
  selectedDice = new Array(numPlayers).fill([]);
  gameStarted = true;

  for (let p = 0; p < numPlayers; p++) {
    const section = document.createElement('div');
    section.className = 'player-section';
    section.innerHTML = `
      <h4>Spelare ${p + 1}</h4>
      <div class="dice-container" id="diceContainer${p}"></div>
      <button class="btn btn-secondary mb-2" onclick="rollDice(${p})" id="rollBtn${p}">Slå tärning</button>
      <div id="suggestions${p}" class="combination"></div>
      <button class="btn btn-outline-primary" onclick="nextPlayer(${p})" id="nextBtn${p}" style="display:none">Nästa spelare</button>
      <table class="table table-bordered text-center">
        <thead>
          <tr>
            <th class="row-label">Ruta</th>
            <th class="column-label">↓</th>
            <th class="column-label">L</th>
            <th class="column-label">↑</th>
            <th class="column-label">1</th>
          </tr>
        </thead>
        <tbody>
          ${generateTableRows(p)}
        </tbody>
      </table>
    `;
    gameArea.appendChild(section);
  }
  currentPlayer = 0;
  updateActivePlayerLabel();
}

function updateActivePlayerLabel() {
  document.getElementById("activePlayerLabel").textContent = `Tur: Spelare ${currentPlayer + 1}`;
}

function generateTableRows(playerIndex) {
  return labels.map((label, i) => `
    <tr>
      <td>${label}</td>
      ${[1,2,3,4].map(c => `<td><input type="number" id="p${playerIndex}_c${c}_r${i}" class="form-control" readonly /></td>`).join('')}
    </tr>
  `).join('');
}

function rollDice(playerIndex) {
  if (!gameStarted || playerIndex !== currentPlayer) return;
  if (rollCounts[playerIndex] >= 3) return;

  if (!selectedDice[playerIndex].length) selectedDice[playerIndex] = [false, false, false, false, false];
  if (!diceValues.length) diceValues = [0, 0, 0, 0, 0];

  for (let i = 0; i < 5; i++) {
    if (!selectedDice[playerIndex][i]) {
      diceValues[i] = Math.floor(Math.random() * 6) + 1;
    }
  }

  updateDiceDisplay(playerIndex);
  rollCounts[playerIndex]++;
  analyzeCombinations(playerIndex);
}

function updateDiceDisplay(playerIndex) {
  const container = document.getElementById(`diceContainer${playerIndex}`);
  container.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const die = document.createElement('div');
    die.className = 'die' + (selectedDice[playerIndex][i] ? ' selected' : '');
    die.textContent = diceValues[i];
    die.onclick = () => {
      selectedDice[playerIndex][i] = !selectedDice[playerIndex][i];
      updateDiceDisplay(playerIndex);
    };
    container.appendChild(die);
  }
}

function nextPlayer(playerIndex) {
  if (!gameStarted || playerIndex !== currentPlayer) return;
  diceValues = [];
  selectedDice[playerIndex] = [];
  rollCounts[playerIndex] = 0;
  document.getElementById(`suggestions${playerIndex}`).innerHTML = '';
  document.getElementById(`nextBtn${playerIndex}`).style.display = 'none';
  const container = document.getElementById(`diceContainer${playerIndex}`);
  container.innerHTML = '';
  currentPlayer = (currentPlayer + 1) % rollCounts.length;
  updateActivePlayerLabel();
}

function determineValidColumns(playerIndex, rowIndex) {
  const result = [];
  const rolls = rollCounts[playerIndex];

  if (rolls === 1) result.push(4);
  result.push(2);

  let allAboveFilled = true;
  for (let i = 0; i < rowIndex; i++) {
    const input = document.getElementById(`p${playerIndex}_c1_r${i}`);
    if (input && input.value === '') {
      allAboveFilled = false;
      break;
    }
  }
  if (allAboveFilled) result.push(1);

  let allBelowFilled = true;
  for (let i = rowIndex + 1; i < labels.length; i++) {
    const input = document.getElementById(`p${playerIndex}_c3_r${i}`);
    if (input && input.value === '') {
      allBelowFilled = false;
      break;
    }
  }
  if (allBelowFilled) result.push(3);

  return result;
}

function analyzeCombinations(playerIndex) {
  const counts = [0, 0, 0, 0, 0, 0];
  for (let val of diceValues) counts[val - 1]++;
  const sum = diceValues.reduce((a, b) => a + b, 0);
  const suggestionBox = document.getElementById(`suggestions${playerIndex}`);
  suggestionBox.innerHTML = '';

  for (let i = 0; i < 6; i++) {
    if (counts[i] > 0) {
      const val = (i + 1) * counts[i];
      const validCols = determineValidColumns(playerIndex, i);
      validCols.forEach(c => {
        const cell = document.getElementById(`p${playerIndex}_c${c}_r${i}`);
        if (cell && cell.value === '') {
          const btn = document.createElement('button');
          btn.className = 'btn btn-success';
          btn.textContent = `Välj ${i + 1}:or → kolumn ${c}`;
          btn.onclick = () => {
            cell.value = val;
            document.getElementById(`nextBtn${playerIndex}`).style.display = 'inline-block';
            suggestionBox.innerHTML = '';
          };
          suggestionBox.appendChild(btn);
        }
      });
    }
  }

  const combos = [
    { label: '2 PAR', condition: () => counts.filter(c => c >= 2).length >= 2, row: 10 },
    { label: 'FULL', condition: () => counts.includes(3) && counts.includes(2), row: 11 },
    { label: 'STEGE', condition: () => JSON.stringify([...new Set(diceValues)].sort()) === JSON.stringify([1,2,3,4,5]) || JSON.stringify([...new Set(diceValues)].sort()) === JSON.stringify([2,3,4,5,6]), row: 12 },
    { label: 'FYRTAL', condition: () => counts.includes(4), row: 13 },
    { label: 'YAN', condition: () => counts.includes(5), row: 14 },
    { label: 'MIN', condition: () => true, row: 8 },
    { label: 'MAX', condition: () => true, row: 9 }
  ];

  combos.forEach(combo => {
    if (combo.condition()) {
      const validCols = determineValidColumns(playerIndex, combo.row);
      validCols.forEach(c => {
        const cell = document.getElementById(`p${playerIndex}_c${c}_r${combo.row}`);
        if (cell && cell.value === '') {
          const btn = document.createElement('button');
          btn.className = 'btn btn-success';
          btn.textContent = `Välj ${combo.label} → kolumn ${c}`;
          btn.onclick = () => {
            cell.value = sum;
            document.getElementById(`nextBtn${playerIndex}`).style.display = 'inline-block';
            suggestionBox.innerHTML = '';
          };
          suggestionBox.appendChild(btn);
        }
      });
    }
  });
}
</script>
</body>
</html>
