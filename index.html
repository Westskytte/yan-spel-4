<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan – Tärningsspel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    table input {
      width: 6ch;
      padding: 0.25rem;
      box-sizing: border-box;
      text-align: center;
    }
    .readonly { background: #eee; }
    .dice-container { margin-bottom: 1rem; }
    .die {
      display: inline-block; width: 40px; height: 40px;
      line-height: 40px; text-align: center;
      font-size: 24px; border: 2px solid #333;
      border-radius: 6px; margin-right: 6px; cursor: pointer;
    }
    .selected { background-color: #d1e7dd; border-color: #0f5132; }
    .player-section { margin-bottom: 2rem; padding: 1rem; border: 2px solid transparent; }
    .active-player { border-color: #0d6efd; background-color: #f0f8ff; }
    .highlighted { background-color: #d4edda !important; }
    .log { font-size: 0.9em; margin-top: 0.5rem; }
    .column-label { width: 60px; text-align: center; }
    .row-label { width: 8ch; text-align: center; }
    .combination { margin-top: 1rem; }
    .combination button { margin: 0.2rem; }
    .fill-button { margin-left: 5px; }
    .suggestions { font-size: 0.9rem; margin-top: 1rem; }
    .suggestion { background: #e2f0d9; margin: 0.2rem 0; padding: 0.3rem; border-radius: 5px; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Yan – Tärningsspel</h1>
  <div class="mb-3">
    <label for="numPlayers" class="form-label">Antal spelare:</label>
    <input type="number" id="numPlayers" class="form-control" min="1" max="6" value="2">
    <button class="btn btn-primary mt-2" id="startBtn">Starta spel</button>
  </div>
  <h3 id="activePlayerLabel" class="text-primary"></h3>
  <div id="gameArea"></div>
</div>
<script>
let diceValues = [0, 0, 0, 0, 0];
let savedDice = [false, false, false, false, false];
let currentPlayerIndex = 0;
let currentRoll = 0;
let numPlayers = 2;

const rows = [
  { key: 'r1', label: '1:or' },
  { key: 'r2', label: '2:or' },
  { key: 'r3', label: '3:or' },
  { key: 'r4', label: '4:or' },
  { key: 'r5', label: '5:or' },
  { key: 'r6', label: '6:or' },
  { key: 'sum', label: 'SUM' },
  { key: 'bonus', label: 'BONUS' },
  { key: 'min', label: 'MIN' },
  { key: 'max', label: 'MAX' },
  { key: 'twopairs', label: '2 PAR' },
  { key: 'full', label: 'FULL' },
  { key: 'straight', label: 'STEGE' },
  { key: 'four', label: 'FYRTAL' },
  { key: 'yan', label: 'YAN' },
  { key: 'total', label: 'TOTAL' }
];

function rollDice(pIndex) {
  if (pIndex !== currentPlayerIndex || currentRoll >= 3) return;
  for (let i = 0; i < 5; i++) {
    if (!savedDice[i]) diceValues[i] = Math.floor(Math.random() * 6) + 1;
  }
  currentRoll++;
  document.getElementById(`rollBtn${pIndex}`).disabled = currentRoll >= 3;
  renderDice(pIndex);
  showSuggestions(pIndex);
}

function renderDice(pIndex) {
  const container = document.getElementById(`dice${pIndex}`);
  container.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const die = document.createElement('div');
    die.className = 'die' + (savedDice[i] ? ' selected' : '');
    die.onclick = () => {
      savedDice[i] = !savedDice[i];
      renderDice(pIndex);
    };
    die.textContent = ['⚀','⚁','⚂','⚃','⚄','⚅'][diceValues[i] - 1] || '-';
    container.appendChild(die);
  }
}

function showSuggestions(pIndex) {
  const container = document.getElementById(`suggestions${pIndex}`);
  container.innerHTML = '<strong>Möjliga kombinationer:</strong>';
  const counts = [0, 0, 0, 0, 0, 0];
  diceValues.forEach(val => { if (val > 0) counts[val - 1]++; });

  for (let i = 0; i < 6; i++) {
    if (counts[i] > 0) {
      const total = counts[i] * (i + 1);
      const div = document.createElement('div');
      div.className = 'suggestion';
      div.innerHTML = `${i + 1}: ${counts[i]}x = ${total}p `;

      // Ny logik för kolumnval baserat på kastnummer
      let validCols = [];
      if (currentRoll === 1) {
        validCols = [4];
      } else {
        validCols = [1, 2, 3];
      }
      validCols.forEach(col => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-success fill-button';
        btn.textContent = `Välj kol ${col}`;
        btn.onclick = () => fillCell(pIndex, col, i + 1, total);
        div.appendChild(btn);
      });
      container.appendChild(div);
    }
  }
}

function fillCell(pIndex, col, val, score) {
  const rowKey = 'r' + val;
  const input = document.getElementById(`p${pIndex}_c${col}_r${val}`);
  if (input && input.value === '') {
    input.value = score;
    document.getElementById(`nextBtn${pIndex}`).disabled = false;
  }
}

function setupGame() {
  numPlayers = parseInt(document.getElementById('numPlayers').value);
  const gameArea = document.getElementById('gameArea');
  gameArea.innerHTML = '';
  for (let i = 0; i < numPlayers; i++) {
    const section = document.createElement('div');
    section.className = 'player-section';
    section.id = `player${i}`;
    const tbody = rows.map((row, rIdx) => {
      const cells = [1, 2, 3, 4].map(c => `<td><input id="p${i}_c${c}_r${rIdx + 1}" readonly></td>`).join('');
      return `<tr><td>${row.label}</td>${cells}</tr>`;
    }).join('');
    section.innerHTML = `
      <h4>Spelare ${i + 1}</h4>
      <div class="dice-container" id="dice${i}"></div>
      <div id="suggestions${i}" class="suggestions"></div>
      <button class="btn btn-secondary mb-2" id="rollBtn${i}" onclick="rollDice(${i})">Slå tärningar</button>
      <button class="btn btn-success mb-2" id="nextBtn${i}" onclick="nextPlayer()" disabled>Nästa spelare</button>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead><tr><th class="row-label">Ruta</th><th class="column-label">↓</th><th class="column-label">L</th><th class="column-label">↑</th><th class="column-label">1</th></tr></thead>
          <tbody id="yanBody${i}">${tbody}</tbody>
        </table>
      </div>
    `;
    gameArea.appendChild(section);
  }
  currentPlayerIndex = 0;
  currentRoll = 0;
  savedDice = [false, false, false, false, false];
  updateActivePlayer();
  renderDice(currentPlayerIndex);
  showSuggestions(currentPlayerIndex);
}

function updateActivePlayer() {
  document.getElementById('activePlayerLabel').innerText = `Tur: Spelare ${currentPlayerIndex + 1}`;
  for (let i = 0; i < numPlayers; i++) {
    document.getElementById(`nextBtn${i}`).disabled = i !== currentPlayerIndex;
    document.getElementById(`rollBtn${i}`).disabled = i !== currentPlayerIndex;
  }
}

function nextPlayer() {
  currentPlayerIndex = (currentPlayerIndex + 1) % numPlayers;
  currentRoll = 0;
  savedDice = [false, false, false, false, false];
  diceValues = [0, 0, 0, 0, 0];
  updateActivePlayer();
  renderDice(currentPlayerIndex);
  showSuggestions(currentPlayerIndex);
}

document.getElementById('startBtn').addEventListener('click', setupGame);
</script>
</body>
</html>
