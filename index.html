<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan-spel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    .dice { font-size: 2rem; cursor: pointer; margin-right: 5px; display: inline-block; width: 40px; height: 40px; text-align: center; line-height: 40px; border: 1px solid #000; border-radius: 6px; }
    .selected { background-color: #d4edda; }
    .combination-btn { margin: 2px; }
    input.readonly { background-color: #eee; pointer-events: none; }
    .active-player { font-weight: bold; color: green; }
    .strike-btn { margin-left: 5px; font-size: 0.8rem; }
    #history { max-height: 200px; overflow-y: auto; margin-top: 2rem; }
  </style>
</head>
<body>
<div class="container">
  <h1>Yan-spel</h1>
  <div class="mb-3">
    <label for="numPlayers" class="form-label">Antal spelare:</label>
    <input type="number" id="numPlayers" class="form-control" value="2" min="1" max="4">
    <div id="nameInputs"></div>
    <button class="btn btn-primary mt-2" onclick="setupGame()">Starta spel</button>
  </div>
  <div id="game"></div>
  <div id="history"><h4>Draghistorik</h4><ul id="historyList" class="list-group"></ul></div>
</div>

<script>
let gameState = {
  currentPlayer: 0,
  players: [],
  dice: [1,1,1,1,1],
  saved: [false, false, false, false, false],
  rollsLeft: 3,
  usedCells: [],
  history: []
};

document.getElementById("numPlayers").addEventListener("change", () => {
  const container = document.getElementById("nameInputs");
  container.innerHTML = "";
  const num = parseInt(document.getElementById("numPlayers").value);
  for (let i = 0; i < num; i++) {
    container.innerHTML += `<input type="text" class="form-control mt-1" placeholder="Namn på spelare ${i + 1}" id="playerName${i}">`;
  }
});

function setupGame() {
  const num = parseInt(document.getElementById("numPlayers").value);
  const game = document.getElementById("game");
  gameState.players = Array(num).fill().map((_, i) => {
    const nameInput = document.getElementById(`playerName${i}`);
    return { name: nameInput && nameInput.value ? nameInput.value : `Spelare ${i+1}`, board: {}, score: 0 };
  });
  game.innerHTML = '';
  gameState.currentPlayer = 0;
  gameState.usedCells = Array(num).fill().map(() => Array(4).fill().map(() => Array(17).fill(false)));
  gameState.history = [];
  updateHistory();

  gameState.players.forEach((player, idx) => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'mb-4';
    playerDiv.innerHTML = `
      <h3 id="playerNameHeader${idx}" class="${idx === gameState.currentPlayer ? 'active-player' : ''}">${player.name}</h3>
      <div id="dice${idx}"></div>
      <div id="combinations${idx}"></div>
      <button class="btn btn-success mt-2" onclick="rollDice(${idx})" id="rollBtn${idx}">Slå tärningar</button>
      <button class="btn btn-secondary mt-2" onclick="nextPlayer()" id="nextBtn${idx}" disabled>Nästa spelare</button>
      <table class="table table-bordered mt-2" id="board${idx}"></table>
      <div><strong>Summa: </strong><span id="sum${idx}">0</span></div>
    `;
    game.appendChild(playerDiv);
    renderBoard(idx);
  });
  renderDice();
  analyzeCombinations();
}

function rollDice(idx) {
  if (idx !== gameState.currentPlayer || gameState.rollsLeft === 0) return;
  for (let i = 0; i < 5; i++) {
    if (!gameState.saved[i]) {
      gameState.dice[i] = Math.floor(Math.random() * 6) + 1;
    }
  }
  gameState.rollsLeft--;
  renderDice();
  analyzeCombinations();
}

function toggleSave(i) {
  gameState.saved[i] = !gameState.saved[i];
  renderDice();
}

function renderDice() {
  const diceDiv = document.getElementById(`dice${gameState.currentPlayer}`);
  diceDiv.innerHTML = gameState.dice.map((val, i) =>
    `<div class="dice ${gameState.saved[i] ? 'selected' : ''}" onclick="toggleSave(${i})">${getDiceSymbol(val)}</div>`
  ).join('') + `<span class="ms-3">Slag kvar: ${gameState.rollsLeft}</span>`;
}

function getDiceSymbol(val) {
  const dots = ["", "⚀","⚁","⚂","⚃","⚄","⚅"];
  return dots[val];
}

function renderBoard(idx) {
  const board = document.getElementById(`board${idx}`);
  const rows = ["1","2","3","4","5","6","SUM","BONUS","MIN","MAX","2PAR","FULL","STEGE","FYRTAL","YAN"];
  const cols = ["↓","L","↑","1"];
  let html = `<tr><th>Ruta</th>${cols.map(c => `<th>${c}</th>`).join('')}</tr>`;
  rows.forEach((row, ri) => {
    html += `<tr><td>${row}</td>`;
    for (let ci = 0; ci < 4; ci++) {
      html += `<td id="cell_${idx}_${ci}_${ri}"><button class='btn btn-sm btn-outline-danger strike-btn' onclick='fillCell(${ci},${ri},0)'>Stryk</button></td>`;
    }
    html += `</tr>`;
  });
  board.innerHTML = html;
}

function analyzeCombinations() {
  const dice = [...gameState.dice];
  const counts = [0,0,0,0,0,0,0];
  dice.forEach(d => counts[d]++);
  const results = [];
  for (let i = 1; i <= 6; i++) {
    if (counts[i] > 0) results.push({ name: `${i}:or`, points: counts[i]*i, row: i-1 });
  }
  const pair2 = counts.filter(c => c >= 2).length >= 2;
  const full = counts.includes(3) && counts.includes(2);
  const stege = JSON.stringify(counts.slice(1)) === JSON.stringify([1,1,1,1,1,0]) || JSON.stringify(counts.slice(1)) === JSON.stringify([0,1,1,1,1,1]);
  const fyrtal = counts.includes(4);
  const yan = counts.includes(5);
  if (pair2) results.push({ name: "2PAR", points: dice.reduce((a,b)=>a+b), row:10 });
  if (full) results.push({ name: "FULL", points: dice.reduce((a,b)=>a+b)+20, row:11 });
  if (stege) results.push({ name: "STEGE", points: 30, row:12 });
  if (fyrtal) results.push({ name: "FYRTAL", points: dice.reduce((a,b)=>a+b), row:13 });
  if (yan) results.push({ name: "YAN", points: 50, row:14 });
  results.push({ name: "MIN", points: dice.reduce((a,b)=>a+b), row:8 });
  results.push({ name: "MAX", points: dice.reduce((a,b)=>a+b), row:9 });
  displayCombinations(results);
}

function displayCombinations(results) {
  const container = document.getElementById(`combinations${gameState.currentPlayer}`);
  container.innerHTML = '<strong>Möjliga kombinationer:</strong><br>';
  results.forEach(r => {
    for (let c = 0; c < 4; c++) {
      const used = gameState.usedCells[gameState.currentPlayer][c][r.row];
      if (!used) {
        container.innerHTML += `<button class="btn btn-sm btn-outline-success combination-btn" onclick="fillCell(${c},${r.row},${r.points})">${r.name} → ${c+1}: ${r.points}p</button>`;
      }
    }
  });
}

function fillCell(col, row, points) {
  const p = gameState.currentPlayer;
  if (gameState.usedCells[p][col][row]) return;
  const cell = document.getElementById(`cell_${p}_${col}_${row}`);
  cell.innerHTML = `<input class="form-control readonly" readonly value="${points}">`;
  gameState.usedCells[p][col][row] = true;
  gameState.players[p].board[`${col}_${row}`] = points;
  gameState.rollsLeft = 0;
  document.getElementById(`nextBtn${p}`).disabled = false;
  document.getElementById(`combinations${p}`).innerHTML = '';
  gameState.history.unshift(`${gameState.players[p].name} valde ruta ${row+1} i kolumn ${col+1} (${points} poäng)`);
  if (gameState.history.length > 10) gameState.history.pop();
  updateHistory();
  calculateSum(p);
  renderDice();
}

function updateHistory() {
  const list = document.getElementById("historyList");
  list.innerHTML = '';
  gameState.history.forEach(h => {
    list.innerHTML += `<li class="list-group-item">${h}</li>`;
  });
}

function calculateSum(p) {
  let total = 0;
  Object.values(gameState.players[p].board).forEach(v => total += v);
  const bonus = (gameState.players[p].board['0_0'] || 0) + (gameState.players[p].board['0_1'] || 0) + (gameState.players[p].board['0_2'] || 0) + (gameState.players[p].board['0_3'] || 0) + (gameState.players[p].board['0_4'] || 0) + (gameState.players[p].board['0_5'] || 0);
  if (bonus >= 84) total += 50;
  document.getElementById(`sum${p}`).innerText = total;
  gameState.players[p].score = total;
}

function nextPlayer() {
  const p = gameState.currentPlayer;
  document.getElementById(`nextBtn${p}`).disabled = true;
  document.getElementById(`playerNameHeader${p}`).classList.remove("active-player");
  gameState.currentPlayer = (p + 1) % gameState.players.length;
  gameState.rollsLeft = 3;
  gameState.dice = [1,1,1,1,1];
  gameState.saved = [false,false,false,false,false];
  document.getElementById(`playerNameHeader${gameState.currentPlayer}`).classList.add("active-player");
  renderDice();
  analyzeCombinations();
  checkWinner();
}

function checkWinner() {
  const allFilled = gameState.players.every(player => Object.keys(player.board).length >= 15 * 1);
  if (allFilled) {
    const winner = gameState.players.reduce((a,b) => a.score > b.score ? a : b);
    alert(`${winner.name} vinner med ${winner.score} poäng!`);
  }
}
</script>
</body>
</html>
