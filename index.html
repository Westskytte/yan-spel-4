<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan ‚Äì T√§rningsspel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    table input { width: 6ch; text-align: center; }
    .readonly { background: #f8f9fa; }
    .die {
      display: inline-block;
      width: 50px;
      height: 50px;
      margin: 4px;
      border: 2px solid #000;
      border-radius: 6px;
      text-align: center;
      line-height: 48px;
      font-size: 24px;
      cursor: pointer;
      background-color: white;
      position: relative;
    }
    .die::before {
      content: attr(data-dots);
      font-size: 24px;
      display: inline-block;
      line-height: 50px;
    }
    .selected { background-color: #d1e7dd; }
    .active-player { border: 2px solid #0d6efd; background-color: #e7f1ff; }
    .suggestion-btn { margin-right: 5px; margin-top: 5px; }
    .disabled { pointer-events: none; opacity: 0.6; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Yan ‚Äì T√§rningsspel</h1>
    <div class="mb-3">
      <label for="numPlayers">Antal spelare:</label>
      <input type="number" id="numPlayers" class="form-control" value="2" min="1" max="6">
      <button class="btn btn-primary mt-2" id="startBtn">Starta spel</button>
    </div>
    <div id="gameArea"></div>
    <div id="winnerDisplay" class="mt-4"></div>
  </div>

  <script>
    let currentPlayer = 0;
    const maxRolls = 3;
    let players = [];
    const ROWS = ["1:or", "2:or", "3:or", "4:or", "5:or", "6:or", "SUMMA", "BONUS", "MIN", "MAX", "2 PAR", "FULL", "STEGE", "FYRTAL", "YAN", "TOTAL"]

    document.getElementById("startBtn").addEventListener("click", setupGame);

    function setupGame() {
      const num = parseInt(document.getElementById("numPlayers").value);
      const gameArea = document.getElementById("gameArea");
      gameArea.innerHTML = "";
      players = [];

      for (let i = 0; i < num; i++) {
        const section = document.createElement("div");
        section.className = "p-3 border rounded mb-4";
        section.id = `player${i}`;
        section.innerHTML = `
          <h3>Spelare ${i + 1}: <input type="text" id="name${i}" placeholder="Namn" /></h3>
          <div id="dice${i}" class="mb-2"></div>
          <button id="roll${i}" class="btn btn-secondary">Sl√• t√§rningar</button>
          <span id="rollCount${i}">Slag kvar: 3</span>
          <div id="suggestions${i}" class="mt-2"></div>
          <button id="nextTurn${i}" class="btn btn-outline-primary mt-2" disabled>N√§sta spelare</button>
          <table class="table table-bordered mt-3 text-center">
            <thead>
              <tr>
                <th>Ruta</th>
                <th>&darr;</th>
                <th>L</th>
                <th>&uarr;</th>
                <th>1</th>
              </tr>
            </thead>
            <tbody id="tableBody${i}"></tbody>
          </table>
        `;
        gameArea.appendChild(section);

        const tbody = document.getElementById(`tableBody${i}`);
        ROWS.forEach((row, r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row}</td>`;
          for (let c = 1; c <= 4; c++) {
            const input = document.createElement("input");
            input.className = "form-control";
            input.type = "text";
            input.readOnly = true;
            input.id = `cell_${i}_${c}_${r}`;
            const td = document.createElement("td");
            td.appendChild(input);
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });

        players.push({
          dice: [0, 0, 0, 0, 0],
          selected: [false, false, false, false, false],
          rollCount: 0,
          hasChosen: false
        });

        document.getElementById(`roll${i}`).addEventListener("click", () => rollDice(i));
        document.getElementById(`nextTurn${i}`).addEventListener("click", () => nextPlayer(i));
      }
      updateActivePlayer();
    }

    function rollDice(p) {
      const player = players[p];
      if (player.rollCount >= maxRolls || p !== currentPlayer) return;

      for (let i = 0; i < 5; i++) {
        if (!player.selected[i]) {
          player.dice[i] = Math.floor(Math.random() * 6) + 1;
        }
      }
      player.rollCount++;
      document.getElementById(`rollCount${p}`).innerText = `Slag kvar: ${maxRolls - player.rollCount}`;
      renderDice(p);
      const combos = analyzeCombinations(p);
      renderSuggestions(p, combos);
    }

    function renderDice(p) {
      const player = players[p];
      const container = document.getElementById(`dice${p}`);
      container.innerHTML = "";
      player.dice.forEach((val, i) => {
        const die = document.createElement("div");
        die.className = "die" + (player.selected[i] ? " selected" : "");
        die.setAttribute("data-dots", getDieUnicode(val));
        die.onclick = () => {
          player.selected[i] = !player.selected[i];
          renderDice(p);
        };
        container.appendChild(die);
      });
    }

    function getDieUnicode(val) {
      const dots = ["‚öÄ", "‚öÅ", "‚öÇ", "‚öÉ", "‚öÑ", "‚öÖ"];
      return val > 0 ? dots[val - 1] : "-";
    }

    function updateActivePlayer() {
      for (let i = 0; i < players.length; i++) {
        document.getElementById(`player${i}`).classList.toggle("active-player", i === currentPlayer);
        document.getElementById(`roll${i}`).disabled = i !== currentPlayer;
        document.getElementById(`nextTurn${i}`).disabled = !players[i].hasChosen || i !== currentPlayer;
      }
    }

    function nextPlayer(i) {
      if (!players[i].hasChosen) return;
      players[i].rollCount = 0;
      players[i].selected = [false, false, false, false, false];
      players[i].hasChosen = false;
      currentPlayer = (currentPlayer + 1) % players.length;
      document.getElementById(`suggestions${i}`).innerHTML = "";
      updateActivePlayer();
    }

    function analyzeCombinations(p) {
      const counts = [0, 0, 0, 0, 0, 0];
      players[p].dice.forEach(val => counts[val - 1]++);
      const sum = players[p].dice.reduce((a, b) => a + b, 0);
      const results = {};
      for (let i = 0; i < 6; i++) {
        if (counts[i] > 0) results[`${i + 1}:or`] = (i + 1) * counts[i];
      }
      if (counts.filter(c => c >= 2).length >= 2) results["2 PAR"] = sum + 10;
      if (counts.includes(3) && counts.includes(2)) results["FULL"] = sum + 20;
      if ((JSON.stringify(counts) === JSON.stringify([1, 1, 1, 1, 1, 0])) || (JSON.stringify(counts) === JSON.stringify([0, 1, 1, 1, 1, 1]))) results["STEGE"] = 20;
      if (counts.includes(4)) results["FYRTAL"] = sum + 40;
      if (counts.includes(5)) results["YAN"] = 50;
      return results;
    }

    function renderSuggestions(p, combos) {
      const container = document.getElementById(`suggestions${p}`);
      container.innerHTML = "<strong>M√∂jliga kombinationer:</strong> ";
      for (let [key, value] of Object.entries(combos)) {
        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-success suggestion-btn";
        btn.textContent = `${key}: ${value} (V√§lj)`;
        btn.onclick = () => selectSuggestion(p, key, value);
        container.appendChild(btn);
      }
    }

    function selectSuggestion(p, key, value) {
      const rowIndex = ROWS.indexOf(key);
      if (rowIndex === -1) return;
      const col = determineColumn(p, rowIndex);
      if (col === -1) return;
      const input = document.getElementById(`cell_${p}_${col}_${rowIndex}`);
      if (input && input.value === "") {
        input.value = value;
        players[p].hasChosen = true;
        updateTotals(p);
        updateActivePlayer();
      }
    }

    function determineColumn(p, row) {
      const rollCount = players[p].rollCount;
      if (rollCount === 1) return 4;
      if (rollCount === 2 || rollCount === 3) {
        // Check column 2 (L)
        const input = document.getElementById(`cell_${p}_2_${row}`);
        if (input && input.value === "") return 2;
        const input3 = document.getElementById(`cell_${p}_3_${row}`);
        if (input3 && input3.value === "") return 3;
      }
      return -1;
    }

    function updateTotals(p) {
      for (let c = 1; c <= 4; c++) {
        let sum = 0;
        for (let r = 0; r <= 5; r++) {
          const val = parseInt(document.getElementById(`cell_${p}_${c}_${r}`).value);
          if (!isNaN(val)) sum += val;
        }
        document.getElementById(`cell_${p}_${c}_6`).value = sum; // SUMMA
        let bonus = 0;
        if (sum >= 60) bonus = 50;
        document.getElementById(`cell_${p}_${c}_7`).value = bonus;

        let total = sum + bonus;
        for (let r = 8; r <= 14; r++) {
          const val = parseInt(document.getElementById(`cell_${p}_${c}_${r}`).value);
          if (!isNaN(val)) total += val;
        }
        const multiplier = [0, 2, 1, 3, 4][c];
        document.getElementById(`cell_${p}_${c}_15`).value = total * multiplier;
      }

      // Check for winner if all TOTAL are filled
      let allDone = true;
      const totals = [];
      const names = [];
      for (let i = 0; i < players.length; i++) {
        let t = 0;
        let filled = true;
        for (let c = 1; c <= 4; c++) {
          const val = parseInt(document.getElementById(`cell_${i}_${c}_15`).value);
          if (!isNaN(val)) t += val;
          else filled = false;
        }
        if (!filled) allDone = false;
        totals.push(t);
        names.push(document.getElementById(`name${i}`).value || `Spelare ${i + 1}`);
      }
      if (allDone) {
        let max = Math.max(...totals);
        let winner = names[totals.indexOf(max)];
        document.getElementById("winnerDisplay").innerHTML = `<div class='alert alert-success'>üèÜ Vinnare: ${winner} med ${max} po√§ng!</div>`;
      }
    }
  </script>
</body>
</html>
